<html>
<head>
  <link rel="stylesheet" type="text/css" href="static/css/screen.css" />
</head>
<body>
    <div class="line" id="outer">
      <div class="unit size3of4">
        <ul class="reset_list columns has_3 fill_auto" id="party">
          <li class="card"></li>
        </ul>
      </div>
      <div class="unit size1of4" id="info_panel">
        <div class="doc_content">
          <p>Text a phrase to (718) 569-8668.</p>
        </div>
        
        <div class="doc_content" id="queue_box">
          <h3>Upcoming parties</h3>
          <ul id="queue_list"></ul>
        </div>
      </div>
    </div>
    
    <script type="text/html" id="translation_tpl">
      <li class="card clr up">
        <div class="doc_content">
          [[#partier]]
            <p class="muted" style="margin: 0;">[[name]] wrote:</p>
          [[/partier]]
          <p class="language small muted">[[l]]</p>
          <p class="translation">[[t]]</p>
        </div>
      </li>
    </script>
    
    <script type="text/html" id="quip_tpl">
      <li class="card clr up [[type]]">
        <div class="doc_content">
          <p class="translation">[[quip]]</p>
        </div>
      </li>
    </script>
    
    <script type="text/html" id="queue_tpl">
      [[#phrases]]
        <li class="">
          [[t]]
        </li>
      [[/phrases]]
    </script>
    
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/mustache.js"></script>
    <script type="text/javascript">
      Mustache.tags = ['[[', ']]'];
    
      /*
      CONSIDER: 
      quip placement
      equilibrium animation
      limit animation
      reset animation
      quip list and types
      */
  
  
      function Party() {
        this.when_party_busted = function(){
          // console.log('party busted, default ending');
        };
        this.phrase_queue = [];
        this.last_displayed_phrase = 0;
        this.party_status = 'partying';
        this.partier = {};
      };
      
      Party.prototype = {
          translation_tpl: $('#translation_tpl').html(),
          quip_tpl: $('#quip_tpl').html(),
          quip_types : [
  					{ 
  					  'type': 'uppercase',
  					  'match': /^[A-Z\s.\?\!]+$/,
  					  'quips': [
  						  "But it's not nice to shout in Japanese, either."
  					  ]
  					},
  					{
  					  'type': 'dirty',
  					  'match': /(fuck|shit|ass|tit|bitch|screw|dick|pussy|nuts|balls)/i,
  					  'quips': [
  						  "Shame on you, by the way.",
  						  "With language like that, you're a real goodwill ambassador!"
  						]
  					},
  					{
  					  'type': 'twitter',
  					  'match': /(twitter|tweet)/i,
  					  'quips': [
  						  "This is better than Twitter, admit it."
  						]
  					},
  					{ 
  					  'type': 'meme',
  					  'match': /(all your base|i can ha[sz]+|never gonna|all the)/i,
  					  'quips': [
  						  "You're sure are up on your Internet jokes!",
  						  "That Internet joke is funny in any language!"
  						]
  					},
  					{
  					  'type': 'tp', 
  					  'match': /(translation|party|who made|who built|\bwill\b|carlough|rick|richard|boenigk)/i,
  					  'quips': [
  						  "Translation Party was made by Will Carlough and Richard Boenigk. <br />Send us an email at <a href='mailto:translationparty@gmail.com'>translationparty@gmail.com</a>"
  						]
  					},
  					{
  					  'type': 'museum', 
  					  'match': /(museum|moving image|movingimage|MovingImageNYC|\bmmi\b)/i,
  					  'quips': [
  						  "It's a pretty cool museum, isn't it?"
  						]
  					},
   					{
   					  'type': 'multipurpose',
  					  'match': /.*/,
    					  'quips': [
    						"This is a real translation party!",
    						"You should move to Japan!",
    						"That's deep, man.",
    						"Come on, you can do better than that.",
    						"That didn't even make that much sense in English."
              ]
  					}
  				],
          
          
          // translating side
        	translate_last_phrase: function(){
            var phrase = this.phrase_queue[this.phrase_queue.length - 1];
            var outLang = (phrase.lang == 'en') ? 'ja' : 'en';
            var self = this;
            
            var translation_success = function(result){
              console.dir(result);
              self.handle_translation_response(result, outLang);
            }
            
            var translation_fail = function(result){
              console.dir(result);
              alert("problem with Bing, probably over limit");
            }
            
  					$.ajax({
  						url: 'http://api.microsofttranslator.com/V2/Ajax.svc/GetTranslations', 
  						data: {
  							'appId' : 'F2926FC35C3732CEC3E9C92913745F9C28912821',
  							'text'  : phrase.string,
  							'from'  : phrase.lang,
  							'to'    : outLang,
  							'maxTranslations' : 1,
  						},
  						dataType: 'jsonp',
  						jsonp : 'oncomplete',
  						success: translation_success,
  						error: translation_fail
  					});
        	},
        	
        	handle_translation_response: function(result, outLang){
            this.phrase_queue.push({
              'lang': outLang,
              'string': result.Translations[0].TranslatedText
            });
            this.check_party_progress();
          },
        
        	// displaying side 
        	display_available_phrase: function(){
        	  
        	  if(this.phrase_queue.length > this.last_displayed_phrase){
        	    var phrase = this.phrase_queue[this.last_displayed_phrase];
        	    if(this.last_displayed_phrase == 0){
        	      // first phrase, show partier info
          	    var $t = $( Mustache.render(this.translation_tpl, {t: phrase.string, l: phrase.lang, partier: this.partier}) ).appendTo('#party');        	              	      
        	    }
        	    else{
          	    var $t = $( Mustache.render(this.translation_tpl, {t: phrase.string, l: phrase.lang}) ).appendTo('#party');        	      
        	    }
              setTimeout( function(){
                $t.removeClass('up');            
              }, 1);
        	    this.last_displayed_phrase++;
        	  }
        	  else{
        	    if( this.party_status != 'partying' ){
        	      //there won't be any more translations coming, so this party is over 
        	      this.bust_this_party();
        	      
        	      var quip, type;
                if( this.party_status == 'limit' ){
                  quip = 'it is unlikely that this phrase will ever reach equilibrium';
                  type = 'abject_failure';
                }
                else{
                  // it hit equilibrium then
                  $('#party li:nth-last-child(-n+3)').css({background: 'lightgreen'});
                  quip = this.get_quip( this.phrase_queue[0].string ); // quip based on original input
                  type = 'success';
                }
                
                var $t = $( Mustache.render(this.quip_tpl, {'quip': quip, 'type': type}) ).appendTo('#party');
                setTimeout( function(){
                  $t.removeClass('up');              
                }, 1);
                
        	    }
        	  }
        	},
        	
        	get_quip: function(phrase){  					
  					var quips, rand;
  					for (var i=0; i<this.quip_types.length; i++){
  					  if( phrase.match(this.quip_types[i].match) ){
  					    quips = this.quip_types[i].quips;
  					    // console.log('matched quip type: '+this.quip_types[i].type);
  					    break;
  					  }
  					}

  					rand = Math.floor(Math.random()*(quips.length));
  					return quips[rand];
  				},
        	
        	// what next?
        	check_party_progress: function(){
        	  if( this.phrase_queue.length > 3 && 
        	      this.phrase_queue[this.phrase_queue.length - 1].lang == 'en' && 
        	      this.phrase_queue[this.phrase_queue.length - 1].string ==  this.phrase_queue[this.phrase_queue.length - 3].string 
        	  ){
        	    // reached equilibrium
        	    this.party_status = 'equilibrium';
        	  }
        	  else if(this.phrase_queue.length == PHRASE_LIMIT){
        	    // hit the limit
        	    this.party_status = 'limit';
        	  }
        	  else{
        	    // carry on then
        	    this.translate_last_phrase();
        	  }
        	},
        	
        	// init
        	get_this_party_started: function(party){
        	  this.phrase_queue.push({
        	    'lang': 'en',
        	    'string': party.t
        	  });
        	  this.partier = party.partier;
        	  this.check_party_progress();
        	  
        	  var self = this;
        	  this.display_interval = setInterval(function(){
        	    self.display_available_phrase();
        	  }, HEARTBEAT_TIME);
        	},
        	
        	// stop -- translating and displaying is completely done
        	bust_this_party: function(){
        	  clearInterval(this.display_interval);
        	  // console.log(this.party_status);
        	  this.when_party_busted();
        	}
        	
      };
      
      
      // party host = this is the controller 
      var HEARTBEAT_TIME = 800;
  	  var BETWEEN_PARTIES_TIME = 15000;
  	  var PHRASE_LIMIT = 20;

      function Party_host(){
        // console.log("hi, i'm the party host.");
        this.party_queue = [];
        this.high_water_id = 0;
      }
      
      Party_host.prototype = {
        queue_tpl: $('#queue_tpl').html(),
        
        fetch_new_parties: function(){
          var self = this;
          $.ajax({
            url: 'ajax', 
            data: {'op': 'getNewerThanId', 'id': this.high_water_id},
            dataType: 'json',
						jsonp : 'oncomplete',
						success: function(data){
              if(typeof data.phrases != 'undefined' && data.phrases.length > 0){
                self.add_to_queue(data.phrases);
                self.high_water_id = data.phrases[data.phrases.length - 1].id;
                // console.log('high id:'+self.high_water_id);
              }
            }});
        },
        
        fetch_fake_parties: function(){
          var attract_mode_phrases = [
            {t: 'Beat it, just beat it! No one wants to be defeated!', 'partier': {'name': '@richardboenigk'} },
            {t: "There's no business like show business like no business I know.", 'partier': {'name': '@sallysmith'} },
            {t: "I'm tweeting this here at the Museum of the Moving Image", 'partier': {'name': 'Someone from Boise, ID'} }
          ];
          this.add_to_queue(attract_mode_phrases);
        },
        
        add_to_queue: function(newparties){
          this.party_queue.push.apply(this.party_queue, newparties);
          this.update_queue_display();
        },
        
        shift_party_from_queue: function(){
          var p = this.party_queue.shift();
          this.update_queue_display();
          return p;
        },
        
        update_queue_display: function(){
          if(this.party_queue.length > 0){
            $('#queue_box').show();
          }
          else{
            $('#queue_box').hide();            
          }
          $('#queue_list').html( Mustache.render(this.queue_tpl, {phrases: this.party_queue.slice(0, 4) } ) );          
        },
        
        consider_next_party: function(){
          this.fetch_new_parties();
          if(this.party_queue.length == 0){
            // console.log('no queued parties, fetch attract mode phrases');
            this.fetch_fake_parties();
          }
          this.clean_up_phrases(this.host_next_party);
          // console.log('phrases in queue: '+this.party_queue.length);
        },
        
        host_next_party: function(){
          var p = new Party();
          var self = this;
          p.when_party_busted = function(){
            setTimeout(function(){
              self.consider_next_party();
            }, BETWEEN_PARTIES_TIME);
          };
          p.get_this_party_started( this.shift_party_from_queue() );
        },
        
        clean_up_phrases: function(on_complete){
          var self = this;
          $('#party').empty();
          on_complete.call(self);          
        },
        
        init: function(){
          var self = this;
          $.ajax({
            url: 'ajax', 
            data: {'op': 'getRecent'},
            dataType: 'json',
						jsonp : 'oncomplete',
						success: function(data){
              if(typeof data.phrases != 'undefined' && data.phrases.length > 0){
                self.add_to_queue(data.phrases);
                self.high_water_id = data.phrases[data.phrases.length - 1].id;
                // console.log('high id:'+self.high_water_id);
              }
              self.consider_next_party();
            }});
        }
        
      }
      
      var ph = new Party_host();
      ph.init();
      
    </script>
    
</body>
</html>